\documentclass{tufte-handout}
\usepackage{../braph2_dev}
\usepackage{graphicx, booktabs, array}
%\geometry{showframe} % display margins for debugging page layout

\title{Implement a new Property Panel}

\begin{document}

\maketitle

\begin{abstract}
\noindent
This is the developer tutorial for implementing a new figure panel. 
In this tutorial, we will explain how to create the generator file \fn{*.gen.m} for a new figure panel, which can then be compiled by \code{braph2genesis}. 
All figure panels are (direct or indirect) extensions of the element \code{PanelFig}.
We will use the figure panels \code{BrainSurfacePF} and \code{BrainAtlasPF} as an examples.
\end{abstract}

\tableofcontents

%%%%% %%%%% %%%%% %%%%% %%%%%
\clearpage
\section{Implementation of Figure Panel (BrainSurfacePF)}

To illustrate the general concepts of a figure panel, we will start by implementing in detail the figure panel \code{BrainSurfacePF}, which is a direct extension of the element \code{PanelFig}.

\begin{lstlisting}[
	label=cd:pf:brainsurfacepf:header,
	caption={
		{\bf BrainSurfacePF element header.}
		The \code{header} section of the generator code for \fn{\_BrainSurfacePF.gen.m} provides the general information about the \code{BrainSurfacePF} element.
	}
]
%% ¡header!
BrainSurfacePF < PanelFig (pf, panel figure brain surface) is a plot of a brain surfce. ¥\circled{1}\circlednote{1}{The element \code{BrainSurfacePF} is defined as a subclass of \code{PabelFig}. The moniker will be \code{pf}.}¥

%%% ¡description!
BrainSurfacePF manages the plot of the brain surface choosen by the user. 
A collection of brain surfaces in NV format can be found in the folder 
./braph2/brainsurfs/.
This class provides the common methods needed to manage the plot of 
the surface. In particular, the user can change lighting, material, 
camlight, shadning, colormap, facecolor, brain color, face color, 
edge color, and background color. 

%%% ¡seealso!
BrainSurface
\end{lstlisting}

\begin{lstlisting}[
	label=cd:pf:brainsurfacepf:constants,
	caption={
		{\bf BrainSurfacePF element constants.}
		The \code{constants} section of the generator code for \fn{\_BrainSurfacePF.gen.m} introductes some element constants. These will simplify the management of the visualization of the brain surface.
	}
]
%% ¡constants!

% fixed 3d view
VIEW_3D	= 1 % 3D view numeric code
VIEW_3D_CMD = '3D' % 3D view name
VIEW_3D_AZEL = [-37.5 30] % 3D view azimutal and polar angles

% sagittal left view
VIEW_SL	= 2 % sagittal left view numeric code
VIEW_SL_CMD = 'Sagittal left' % sagittal left view name
VIEW_SL_AZEL = [-90 0] % sagittal left view azimutal and polar angles

% sagittal right view
VIEW_SR	= 3 % sagittal right view numeric code
VIEW_SR_CMD = 'Sagittal right' % sagittal right view name
VIEW_SR_AZEL = [90 0] % sagittal right view azimutal and polar angles 

% axial dorsal view
VIEW_AD = 4 % axial dorsal view numeric code
VIEW_AD_CMD = 'Axial dorsal' % axial dorsal view name
VIEW_AD_AZEL = [0 90] % axial dorsal view azimutal and polar angles

% axial ventral view
VIEW_AV = 5 % axial ventral view numeric code
VIEW_AV_CMD = 'Axial ventral' % axial ventral view name
VIEW_AV_AZEL = [0 -90] % axial ventral view azimutal and polar angles

% coronal anterior view
VIEW_CA = 6 % coronal anterior view numeric code
VIEW_CA_CMD = 'Coronal anterior' % coronal anterior view name
VIEW_CA_AZEL = [180 0] % coronal anterior view azimutal and polar angles

% coronal posterior view
VIEW_CP = 7 % coronal posterior view numeric code
VIEW_CP_CMD = 'Coronal posterior' % coronal posterior view name
VIEW_CP_AZEL = [0 0] % coronal posterior view azimutal and polar angles

VIEW_CMD = { ... % vector of view names
    BrainSurfacePF.VIEW_3D_CMD ...
    BrainSurfacePF.VIEW_SL_CMD ...
    BrainSurfacePF.VIEW_SR_CMD ...
    BrainSurfacePF.VIEW_AD_CMD ...
    BrainSurfacePF.VIEW_AV_CMD ...
    BrainSurfacePF.VIEW_CA_CMD ...
    BrainSurfacePF.VIEW_CP_CMD ...
    }

VIEW_AZEL = { ... % vector of view azimutal and polar angle
    BrainSurfacePF.VIEW_3D_AZEL ...
    BrainSurfacePF.VIEW_SL_AZEL ...
    BrainSurfacePF.VIEW_SR_AZEL ...
    BrainSurfacePF.VIEW_AD_AZEL ...
    BrainSurfacePF.VIEW_AV_AZEL ...
    BrainSurfacePF.VIEW_CA_AZEL ...
    BrainSurfacePF.VIEW_CP_AZEL ...
    }
\end{lstlisting}

\begin{lstlisting}[
	label=cd:pf:brainsurfacepf:props,
	caption={
		{\bf BrainSurfacePF element new props.}
		The \code{props} section of the generator code for \fn{\_BrainSurfacePF.gen.m} defines the necessary user interface objects and their callbacks.
	}
]
%% ¡props!

%%% ¡prop!
H_AXES (evanescent, handle) is the handle for the axes. ¥\circled{1}\circlednote{1}{defines the evanescent handle of the axes where the brain surface will be plotted. It also defines its general properties.}¥
%%%% ¡calculate!
h_axes = uiaxes( ...
    'Parent', pf.memorize('H'), ... ¥\circled{2}\circlednote{2}{ensures that the parent panel is memorized.}¥
    'Tag', 'H_AXES', ...
    'Units', 'normalized', ...
    'OuterPosition', [0 0 1 1] ...
    );
h_axes.Toolbar.Visible = 'off';
h_axes.Interactions = [];
value = h_axes;

%%% ¡prop!
VIEW (figure, rvector) sets the desired view as the line-of-sight azimuth and elevation angles. ¥\circled{3}\circlednote{3}{determines the view of the brain surface.}¥
%%%% ¡check_prop!
check = length(value) == 2;
%%%% ¡default!
BrainSurfacePF.VIEW_SL_AZEL
%%%% ¡postset! ¥\circled{4}\circlednote{4}{is executed only when the \code{VIEW} property is set. It takes care of adjusting the view and resetting the lightning.}¥
if pf.get('DRAWN')
    view(pf.get('H_AXES'), pf.get('VIEW'))
    
    % reset the ambient lighting
    pf.memorize('ST_AMBIENT').set('PANEL', pf, 'PROP', pf.H_AXES).get('SETUP')
            %%%    
            %%%    % update state of toggle tools
            %%%    toolbar = pf.get('H_TOOLBAR');
            %%%    if check_graphics(toolbar, 'uitoolbar')
            %%%        set(findobj(toolbar, 'Tag', 'TOOL.View3D'), 'State', isequal(pf.get('VIEW'), BrainSurfacePF.VIEW_3D_AZEL))
            %%%        set(findobj(toolbar, 'Tag', 'TOOL.ViewSL'), 'State', isequal(pf.get('VIEW'), BrainSurfacePF.VIEW_SL_AZEL))
            %%%        set(findobj(toolbar, 'Tag', 'TOOL.ViewSR'), 'State', isequal(pf.get('VIEW'), BrainSurfacePF.VIEW_SR_AZEL))
            %%%        set(findobj(toolbar, 'Tag', 'TOOL.ViewAD'), 'State', isequal(pf.get('VIEW'), BrainSurfacePF.VIEW_AD_AZEL))
            %%%        set(findobj(toolbar, 'Tag', 'TOOL.ViewAV'), 'State', isequal(pf.get('VIEW'), BrainSurfacePF.VIEW_AV_AZEL))
            %%%        set(findobj(toolbar, 'Tag', 'TOOL.ViewCA'), 'State', isequal(pf.get('VIEW'), BrainSurfacePF.VIEW_CA_AZEL))
            %%%        set(findobj(toolbar, 'Tag', 'TOOL.ViewCP'), 'State', isequal(pf.get('VIEW'), BrainSurfacePF.VIEW_CP_AZEL))
            %%%    end
end
%%%% ¡gui!
pr = PanelPropRVectorView('EL', pf, 'PROP', BrainSurfacePF.VIEW, varargin{:});

%%% ¡prop!
ST_AXIS (figure, item) determines the axis settings. ¥\circled{5}\circlednote{5}{determines the axis setting through the container property \code{SettingsAxis}, which derives from \code{Settings}.}¥
%%%% ¡settings!
'SettingsAxis'
%%%% ¡default!
SettingsAxis('GRID', false, 'AXIS', false) ¥\circled{6}\circlednote{6}{defines the default values by instantiating a default instance of \code{SettingsAxis}.}¥
            %%%%%%% ¡postset!
            %%%if pf.get('DRAWN')
            %%%    toolbar = pf.get('H_TOOLBAR');
            %%%    if check_graphics(toolbar, 'uitoolbar')
            %%%        set(findobj(toolbar, 'Tag', 'TOOL.Grid'), 'State', pf.get('ST_AXIS').get('GRID'))
            %%%        set(findobj(toolbar, 'Tag', 'TOOL.Axis'), 'State', pf.get('ST_AXIS').get('AXIS'))
            %%%    end
            %%%end
%%%% ¡gui! ¥\circled{7}\circlednote{7}{employs the property panel \code{SettingsAxisPP}, which is specialized for \code{SettingsAxis} and derives from \code{SettingsPP}.}¥
pr = SettingsAxisPP('EL', pf, 'PROP', BrainSurfacePF.ST_AXIS, varargin{:});

            %%%%%% ¡prop!
            %%%LISTENER_ST_AXIS (evanescent, handle) contains the listener to the axis settings to update the pushbuttons.
            %%%%%%% ¡calculate!
            %%%value = listener(pf.get('ST_AXIS'), 'PropSet', @cb_listener_st_axis); 
            %%%%%%% ¡calculate_callbacks!
            %%%function cb_listener_st_axis(~, ~)
            %%%    if pf.get('DRAWN')
            %%%        toolbar = pf.get('H_TOOLBAR');
            %%%        if check_graphics(toolbar, 'uitoolbar')
            %%%            set(findobj(toolbar, 'Tag', 'TOOL.Grid'), 'State', pf.get('ST_AXIS').get('GRID'))
            %%%            set(findobj(toolbar, 'Tag', 'TOOL.Axis'), 'State', pf.get('ST_AXIS').get('AXIS'))
            %%%        end
            %%%    end
            %%%end

%%% ¡prop!
SURFFILE (figure, option) is the name of the file of the brain surface to be plotted. ¥\circled{8}\circlednote{8}{contains the file from which the brain surface is plotted.}¥
%%%% ¡settings!
{dir([fileparts(which('braph2')) filesep() 'brainsurfs' filesep() '*.nv']).name}
%%%% ¡default!
'human_ICBM152.nv'
%%%% ¡postset! ¥\circled{9}\circlednote{9}{is executed only when the \code{SURFILE} property is set. It updates the property \code{SURF} loading the data from the file. It the figure panel is already drawn, it refreshes the brain handle and redraws it.}¥
bs = ImporterBrainSurfaceNV('FILE', pf.get('SURFFILE')).get('SURF');
pf.set('SURF', bs)

if pf.get('DRAWN')
    delete(pf.get('H_BRAIN'))
    pf.set('H_BRAIN', Element.getNoValue())

    pf.memorize('H_BRAIN')

    pf.set('BRAIN', pf.get('BRAIN'))

    pf.memorize('ST_SURFACE').set('PANEL', pf, 'PROP', pf.H_BRAIN).get('SETUP')

    pf.memorize('ST_AMBIENT').set('PANEL', pf, 'PROP', pf.H_AXES).get('SETUP')
end

%%% ¡prop!
SURF (metadata, item) is the brain surface to be plotted. ¥\circled{10}\circlednote{10}{contains the \code{BrainSurface} element.}¥
%%%% ¡settings!
'BrainSurface'
%%%% ¡default!
ImporterBrainSurfaceNV('FILE', BrainSurfacePF.getPropDefault('SURFFILE')).get('SURF')

%%% ¡prop!
H_BRAIN (evanescent, handle) is the handle for brain surface. ¥\circled{11}\circlednote{11}{is the evanescent handle for the brain surface. This is calcualted by \circled{12}.}¥
%%%% ¡calculate! ¥\circled{12}¥
triangles = pf.get('SURF').get('TRIANGLES');
coordinates = pf.get('SURF').get('COORDINATES');
h_brain = trisurf( ...
    triangles, ...
    coordinates(:, 1), ...
    coordinates(:, 2), ...
    coordinates(:, 3), ...
    'Parent', pf.memorize('H_AXES'), ...
    'Tag', 'H_BRAIN' ...
    );
xlabel(pf.get('H_AXES'), 'Sagittal')
ylabel(pf.get('H_AXES'), 'Axial')
zlabel(pf.get('H_AXES'), 'Coronal')
value = h_brain;

%%% ¡prop!
BRAIN (figure, logical) determines whether the brain surface is shown. ¥\circled{13}\circlednote{13}{determines whether the brain surface is shown.}¥
%%%% ¡default!
true
%%%% ¡postset!
if pf.get('DRAWN')
    if pf.get('BRAIN')
        set(pf.get('H_BRAIN'), 'Visible', 'on')
    else % ~pf.get('BRAIN') 
        set(pf.get('H_BRAIN'), 'Visible', 'off')
    end
            %%%
            %%%    toolbar = pf.get('H_TOOLBAR');
            %%%    if check_graphics(toolbar, 'uitoolbar')
            %%%        set(findobj(toolbar, 'Tag', 'TOOL.Brain'), 'State', pf.get('BRAIN'))
            %%%    end
end

%%% ¡prop!
ST_SURFACE (figure, item) determines the surface settings. ¥\circled{14}\circlednote{14}{determines the brain surface settings throught the container property \code{SettingsSurface}, which derives from \code{Settings}.}¥
%%%% ¡settings!
'SettingsSurface'
%%%% ¡gui!
pr = SettingsSurfacePP('EL', pf, 'PROP', BrainSurfacePF.ST_SURFACE, varargin{:}); ¥\circled{15}\circlednote{15}{employs the property panel \code{SettingsSurfacePP}, which is specialized for \code{SettingsSurface} and derives from \code{SettingsPP}.}¥

%%% ¡prop!
ST_AMBIENT (figure, item) determines the ambient settings. ¥\circled{16}\circlednote{16}{determines the ambient lighting settings throught the container property \code{SettingsAmbient}, which is derived from \code{Settings}.}¥
%%%% ¡settings!
'SettingsAmbient'
%%%% ¡default!
SettingsAmbient('LIGHTING', 'gouraud', 'MATERIAL', 'dull', 'CAMLIGHT', 'headlight (x2)', 'SHADING', 'none', 'COLORMAP', 'none') ¥\circled{17}\circlednote{17}{defines the default values by instantiating a default instance of \code{SettingsAmbient}.}¥
%%%% ¡gui!
pr = SettingsAmbientPP('EL', pf, 'PROP', BrainSurfacePF.ST_AMBIENT, varargin{:}); ¥\circled{18}\circlednote{18}{employs the property panel \code{SettingsAmbientPP}, which is specialized for \code{SettingsAmbient} and derives from \code{SettingsPP}.}¥
\end{lstlisting}

\begin{lstlisting}[
	label=cd:pf:brainsurfacepf:props_update,
	caption={
		{\bf BrainSurfacePF element props update.}
		The \code{props\_update} section of the generator code for \fn{\_BrainSurfacePF.gen.m} updates the properties of the \code{PanelFig} element. This defines the core properties of the property panel.
	}
]
%% ¡props_update!
...
%%% ¡prop!
DRAW (query, logical) draws the figure brain surface. ¥\circled{1}\circlednote{1}{initializes the various graphical elements are drawn.}¥
%%%% ¡calculate!
value = calculateValue@PanelFig(pf, PanelFig.DRAW, varargin{:}); ¥\circled{2}\circlednote{2}{calls the constructor of the parent. It returns \code{value = true} if the panel is drawn correctly. It gives a warning if the panel is not drawn correctly.}¥
if value
    pf.memorize('H_AXES') ¥\circled{3}\circlednote{3}{ensures that the axes are memorized.}¥
            %%%        
            %%%    pf.set('VIEW', pf.get('VIEW'))

    pf.memorize('ST_AXIS').set('PANEL', pf, 'PROP', BrainSurfacePF.H_AXES).get('SETUP') ¥\circled{4}\circlednote{4}{creates, memorizes, and sets up the property \code{H\_AXES}.}¥
            %%%    pf.memorize('LISTENER_ST_AXIS');
    
    pf.memorize('H_BRAIN') ¥\circled{5}\circlednote{5}{memorizes the property \code{H\_BRAIN}.}¥
            %%%    
            %%%    pf.set('BRAIN', pf.get('BRAIN'))

    pf.memorize('ST_SURFACE').set('PANEL', pf, 'PROP', BrainSurfacePF.H_BRAIN).get('SETUP') ¥\circled{6}\circlednote{6}{creates, memorizes, and sets up the property \code{ST\_SURFACE}.}¥
    
    pf.memorize('ST_AMBIENT').set('PANEL', pf, 'PROP', BrainSurfacePF.H_AXES).get('SETUP') ¥\circled{7}\circlednote{7}{creates, memorizes, and sets up the property \code{ST\_AMBIENT}.}¥
end

%%% ¡prop!
DELETE (query, logical) resets the handles when the panel figure brain surface is deleted. ¥\circled{8}\circlednote{8}{deletes all evanescent hnadles when the figure containing the panel is deleted.}¥
%%%% ¡calculate!
value = calculateValue@PanelFig(pf, PanelFig.DELETE, varargin{:}); % also warning
if value
    pf.set('H_AXES', Element.getNoValue())
    pf.set('H_BRAIN', Element.getNoValue())
            %%%    
            %%%    pf.set('LISTENER_ST_AXIS', Element.getNoValue())
end

            %%%%%% ¡prop!
            %%%H_TOOLS (evanescent, handlelist) is the list of panel-specific tools from the first.
            %%%%%%% ¡calculate!
            %%%toolbar = pf.memorize('H_TOOLBAR');
            %%%if check_graphics(toolbar, 'uitoolbar')
            %%%    value = calculateValue@PanelFig(pf, PanelFig.H_TOOLS);
            %%%    
            %%%    tool_separator_1 = uipushtool(toolbar, 'Separator', 'on', 'Visible', 'off');
            %%%
            %%%    % Brain
            %%%    tool_brain = uitoggletool(toolbar, ...
            %%%        'Tag', 'TOOL.Brain', ...
            %%%        'Separator', 'on', ...
            %%%        'State', pf.get('BRAIN'), ...
            %%%        'Tooltip', 'Show Brain', ...
            %%%        'CData', imread('icon_brain.png'), ...
            %%%        'OnCallback', {@cb_brain, true}, ...
            %%%        'OffCallback', {@cb_brain, false});
            %%%
            %%%    % Axis
            %%%    tool_axis = uitoggletool(toolbar, ...
            %%%        'Tag', 'TOOL.Axis', ...
            %%%        'State', pf.get('ST_AXIS').get('AXIS'), ...
            %%%        'Tooltip', 'Show axis', ...
            %%%        'CData', imread('icon_axis.png'), ...
            %%%        'OnCallback', {@cb_axis, true}, ...
            %%%        'OffCallback', {@cb_axis, false});
            %%%
            %%%    % Grid
            %%%    tool_grid = uitoggletool(toolbar, ...
            %%%        'Tag', 'TOOL.Grid', ...
            %%%        'State', pf.get('ST_AXIS').get('GRID'), ...
            %%%        'Tooltip', 'Show grid', ...
            %%%        'CData', imread('icon_grid.png'), ...
            %%%        'OnCallback', {@cb_grid, true}, ...
            %%%        'OffCallback', {@cb_grid, false});
            %%%        
            %%%    tool_separator_2 = uipushtool(toolbar, 'Separator', 'on', 'Visible', 'off');
            %%%
            %%%    % View 3D
            %%%    tool_view3D = uitoggletool(toolbar, ...
            %%%        'Tag', 'TOOL.View3D', ...
            %%%        'Separator', 'on', ... 
            %%%        'State', isequal(pf.get('VIEW'), BrainSurfacePF.VIEW_3D_AZEL), ...
            %%%        'Tooltip', BrainSurfacePF.VIEW_3D_CMD, ...
            %%%        'CData', imread('icon_view_3d.png'), ...
            %%%        'ClickedCallback', {@cb_view, BrainSurfacePF.VIEW_3D_AZEL});
            %%%
            %%%    % View SL
            %%%    tool_viewSL = uitoggletool(toolbar, ...
            %%%        'Tag', 'TOOL.ViewSL', ...
            %%%        'State', isequal(pf.get('VIEW'), BrainSurfacePF.VIEW_SL_AZEL), ...
            %%%        'Tooltip', BrainSurfacePF.VIEW_SL_CMD, ...
            %%%        'CData', imread('icon_view_sl.png'), ...
            %%%        'ClickedCallback', {@cb_view, BrainSurfacePF.VIEW_SL_AZEL});
            %%%
            %%%    % View SR
            %%%    tool_viewSR = uitoggletool(toolbar, ...
            %%%        'Tag', 'TOOL.ViewSR', ...
            %%%        'State', isequal(pf.get('VIEW'), BrainSurfacePF.VIEW_SR_AZEL), ...
            %%%        'Tooltip', BrainSurfacePF.VIEW_SR_CMD, ...
            %%%        'CData', imread('icon_view_sr.png'), ...
            %%%        'ClickedCallback', {@cb_view, BrainSurfacePF.VIEW_SR_AZEL});
            %%%
            %%%    % View AD
            %%%    tool_viewAD = uitoggletool(toolbar, ...
            %%%        'Tag', 'TOOL.ViewAD', ...
            %%%        'State', isequal(pf.get('VIEW'), BrainSurfacePF.VIEW_AD_AZEL), ...
            %%%        'Tooltip', BrainSurfacePF.VIEW_AD_CMD, ...
            %%%        'CData', imread('icon_view_ad.png'), ...
            %%%        'ClickedCallback', {@cb_view, BrainSurfacePF.VIEW_AD_AZEL});
            %%%
            %%%    % View AV
            %%%    tool_viewAV = uitoggletool(toolbar, ...
            %%%        'Tag', 'TOOL.ViewAV', ...
            %%%        'State', isequal(pf.get('VIEW'), BrainSurfacePF.VIEW_AV_AZEL), ...
            %%%        'Tooltip', BrainSurfacePF.VIEW_AV_CMD, ...
            %%%        'CData', imread('icon_view_av.png'), ...
            %%%        'ClickedCallback', {@cb_view, BrainSurfacePF.VIEW_AV_AZEL});
            %%%
            %%%    % View CA
            %%%    tool_viewCA = uitoggletool(toolbar, ...
            %%%        'Tag', 'TOOL.ViewCA', ...
            %%%        'State', isequal(pf.get('VIEW'), BrainSurfacePF.VIEW_CA_AZEL), ...
            %%%        'Tooltip', BrainSurfacePF.VIEW_CA_CMD, ...
            %%%        'CData', imread('icon_view_ca.png'), ...
            %%%        'ClickedCallback', {@cb_view, BrainSurfacePF.VIEW_CA_AZEL});
            %%%
            %%%    % View CP
            %%%    tool_viewCP = uitoggletool(toolbar, ...
            %%%        'Tag', 'TOOL.ViewCP', ...
            %%%        'State', isequal(pf.get('VIEW'), BrainSurfacePF.VIEW_CP_AZEL), ...
            %%%        'Tooltip', BrainSurfacePF.VIEW_CP_CMD, ...
            %%%        'CData', imread('icon_view_cp.png'), ...
            %%%        'ClickedCallback', {@cb_view, BrainSurfacePF.VIEW_CP_AZEL});
            %%%    
            %%%    value = {value{:}, ...
            %%%        tool_separator_1, ...
            %%%        tool_brain, tool_axis, tool_grid, ...
            %%%        tool_separator_2, ...
            %%%        tool_view3D, tool_viewSL, tool_viewSL, tool_viewSR, tool_viewAD, tool_viewAV, tool_viewCA, tool_viewCP ...
            %%%        };
            %%%else
            %%%    value = {};
            %%%end
            %%%%%%% ¡calculate_callbacks!
            %%%function cb_brain(~, ~, brain) % (src, event)
            %%%    pf.set('BRAIN', brain)
            %%%end
            %%%function cb_axis(~, ~, axis) % (src, event)
            %%%    pf.get('ST_AXIS').set('AXIS', axis);
            %%%    
            %%%    % triggers the update of ST_AXIS
            %%%    pf.set('ST_AXIS', pf.get('ST_AXIS'))
            %%%end
            %%%function cb_grid(~, ~, grid) % (src, event)
            %%%    pf.get('ST_AXIS').set('GRID', grid);
            %%%
            %%%    % triggers the update of ST_AXIS
            %%%    pf.set('ST_AXIS', pf.get('ST_AXIS'))
            %%%end
            %%%function cb_view(~, ~, azel) % (src, event)
            %%%    pf.set('VIEW', azel)
            %%%end
\end{lstlisting}

\begin{lstlisting}[
	label=cd:pf:brainsurfacepf:tests,
	caption={
		{\bf BrainSurfacePF element tests.}
		The \code{tests} section of the generator code for \fn{\_BrainSurfacePF.gen.m} determines how the unit tests are performd.
	}
]
%% ¡tests!

%%% ¡excluded_props! ¥\circled{1}\circlednote{1}{some properties need to be excluded from the tests, mainly because they are initialized by other proprties and therefore could give some spurious errors.}¥
[BrainSurfacePF.PARENT BrainSurfacePF.H BrainSurfacePF.ST_POSITION BrainSurfacePF.ST_AXIS BrainSurfacePF.ST_SURFACE BrainSurfacePF.ST_AMBIENT]
            %%%[BrainSurfacePF.PARENT BrainSurfacePF.H BrainSurfacePF.ST_POSITION BrainSurfacePF.ST_AXIS BrainSurfacePF.ST_SURFACE BrainSurfacePF.ST_AMBIENT BrainSurfacePF.LISTENER_ST_AXIS] 

%%% ¡warning_off!
true

%%% ¡test!
%%%% ¡name!
Remove Figures
%%%% ¡code!
warning('off', [BRAPH2.STR ':BrainSurfacePF'])
assert(length(findall(0, 'type', 'figure')) == 1) ¥\circled{2}\circlednote{2}{throws an error if there remains a different number of figures than expected.}¥
delete(findall(0, 'type', 'figure')) ¥\circled{3}\circlednote{3}{removes the figures remaining from the testing.}¥
warning('on', [BRAPH2.STR ':BrainSurfacePF'])
\end{lstlisting}

\subsection{Addition of Toolbar Buttons}

We will now see how to add the pushbuttons in the toolbar of the figure, opportunely altering the code so far implemented.

\begin{lstlisting}[
	label=cd:pf:brainsurfacepf:header,
	caption={
		{\bf BrainSurfacePF element header.}
		The \code{header} section of the generator code for \fn{\_BrainSurfacePF.gen.m} provides the general information about the \code{BrainSurfacePF} element.
	}
]
%% ¡header!
BrainSurfacePF < PanelFig (pf, panel figure brain surface) is a plot of a brain surfce. ¥\circled{1}\circlednote{1}{The element \code{BrainSurfacePF} is defined as a subclass of \code{PabelFig}. The moniker will be \code{pf}.}¥

%%% ¡description!
BrainSurfacePF manages the plot of the brain surface choosen by the user. 
A collection of brain surfaces in NV format can be found in the folder 
./braph2/brainsurfs/.
This class provides the common methods needed to manage the plot of 
the surface. In particular, the user can change lighting, material, 
camlight, shadning, colormap, facecolor, brain color, face color, 
edge color, and background color. 

%%% ¡seealso!
BrainSurface
\end{lstlisting}

\begin{lstlisting}[
	label=cd:pf:brainsurfacepf:constants,
	caption={
		{\bf BrainSurfacePF element constants.}
		The \code{constants} section of the generator code for \fn{\_BrainSurfacePF.gen.m} introductes some element constants. These will simplify the management of the visualization of the brain surface.
	}
]
%% ¡constants!

% fixed 3d view
VIEW_3D	= 1 % 3D view numeric code
VIEW_3D_CMD = '3D' % 3D view name
VIEW_3D_AZEL = [-37.5 30] % 3D view azimutal and polar angles

% sagittal left view
VIEW_SL	= 2 % sagittal left view numeric code
VIEW_SL_CMD = 'Sagittal left' % sagittal left view name
VIEW_SL_AZEL = [-90 0] % sagittal left view azimutal and polar angles

% sagittal right view
VIEW_SR	= 3 % sagittal right view numeric code
VIEW_SR_CMD = 'Sagittal right' % sagittal right view name
VIEW_SR_AZEL = [90 0] % sagittal right view azimutal and polar angles 

% axial dorsal view
VIEW_AD = 4 % axial dorsal view numeric code
VIEW_AD_CMD = 'Axial dorsal' % axial dorsal view name
VIEW_AD_AZEL = [0 90] % axial dorsal view azimutal and polar angles

% axial ventral view
VIEW_AV = 5 % axial ventral view numeric code
VIEW_AV_CMD = 'Axial ventral' % axial ventral view name
VIEW_AV_AZEL = [0 -90] % axial ventral view azimutal and polar angles

% coronal anterior view
VIEW_CA = 6 % coronal anterior view numeric code
VIEW_CA_CMD = 'Coronal anterior' % coronal anterior view name
VIEW_CA_AZEL = [180 0] % coronal anterior view azimutal and polar angles

% coronal posterior view
VIEW_CP = 7 % coronal posterior view numeric code
VIEW_CP_CMD = 'Coronal posterior' % coronal posterior view name
VIEW_CP_AZEL = [0 0] % coronal posterior view azimutal and polar angles

VIEW_CMD = { ... % vector of view names
    BrainSurfacePF.VIEW_3D_CMD ...
    BrainSurfacePF.VIEW_SL_CMD ...
    BrainSurfacePF.VIEW_SR_CMD ...
    BrainSurfacePF.VIEW_AD_CMD ...
    BrainSurfacePF.VIEW_AV_CMD ...
    BrainSurfacePF.VIEW_CA_CMD ...
    BrainSurfacePF.VIEW_CP_CMD ...
    }

VIEW_AZEL = { ... % vector of view azimutal and polar angle
    BrainSurfacePF.VIEW_3D_AZEL ...
    BrainSurfacePF.VIEW_SL_AZEL ...
    BrainSurfacePF.VIEW_SR_AZEL ...
    BrainSurfacePF.VIEW_AD_AZEL ...
    BrainSurfacePF.VIEW_AV_AZEL ...
    BrainSurfacePF.VIEW_CA_AZEL ...
    BrainSurfacePF.VIEW_CP_AZEL ...
    }
\end{lstlisting}

\begin{lstlisting}[
	label=cd:pf:brainsurfacepf:props,
	caption={
		{\bf BrainSurfacePF element new props.}
		The \code{props} section of the generator code for \fn{\_BrainSurfacePF.gen.m} defines the necessary user interface objects and their callbacks.
	}
]
%% ¡props!

%%% ¡prop!
H_AXES (evanescent, handle) is the handle for the axes. ¥\circled{1}\circlednote{1}{defines the evanescent handle of the axes where the brain surface will be plotted. It also defines its general properties.}¥
%%%% ¡calculate!
h_axes = uiaxes( ...
    'Parent', pf.memorize('H'), ... ¥\circled{2}\circlednote{2}{ensures that the parent panel is memorized.}¥
    'Tag', 'H_AXES', ...
    'Units', 'normalized', ...
    'OuterPosition', [0 0 1 1] ...
    );
h_axes.Toolbar.Visible = 'off';
h_axes.Interactions = [];
value = h_axes;

%%% ¡prop!
VIEW (figure, rvector) sets the desired view as the line-of-sight azimuth and elevation angles. ¥\circled{3}\circlednote{3}{determines the view of the brain surface.}¥
%%%% ¡check_prop!
check = length(value) == 2;
%%%% ¡default!
BrainSurfacePF.VIEW_SL_AZEL
%%%% ¡postset! ¥\circled{4}\circlednote{4}{is executed only when the \code{VIEW} property is set. It takes care of adjusting the view and resetting the lightning.}¥
if pf.get('DRAWN')
    view(pf.get('H_AXES'), pf.get('VIEW'))
    
    % reset the ambient lighting
    pf.memorize('ST_AMBIENT').set('PANEL', pf, 'PROP', pf.H_AXES).get('SETUP')
            %%%    
            %%%    % update state of toggle tools
            %%%    toolbar = pf.get('H_TOOLBAR');
            %%%    if check_graphics(toolbar, 'uitoolbar')
            %%%        set(findobj(toolbar, 'Tag', 'TOOL.View3D'), 'State', isequal(pf.get('VIEW'), BrainSurfacePF.VIEW_3D_AZEL))
            %%%        set(findobj(toolbar, 'Tag', 'TOOL.ViewSL'), 'State', isequal(pf.get('VIEW'), BrainSurfacePF.VIEW_SL_AZEL))
            %%%        set(findobj(toolbar, 'Tag', 'TOOL.ViewSR'), 'State', isequal(pf.get('VIEW'), BrainSurfacePF.VIEW_SR_AZEL))
            %%%        set(findobj(toolbar, 'Tag', 'TOOL.ViewAD'), 'State', isequal(pf.get('VIEW'), BrainSurfacePF.VIEW_AD_AZEL))
            %%%        set(findobj(toolbar, 'Tag', 'TOOL.ViewAV'), 'State', isequal(pf.get('VIEW'), BrainSurfacePF.VIEW_AV_AZEL))
            %%%        set(findobj(toolbar, 'Tag', 'TOOL.ViewCA'), 'State', isequal(pf.get('VIEW'), BrainSurfacePF.VIEW_CA_AZEL))
            %%%        set(findobj(toolbar, 'Tag', 'TOOL.ViewCP'), 'State', isequal(pf.get('VIEW'), BrainSurfacePF.VIEW_CP_AZEL))
            %%%    end
end
%%%% ¡gui!
pr = PanelPropRVectorView('EL', pf, 'PROP', BrainSurfacePF.VIEW, varargin{:});

%%% ¡prop!
ST_AXIS (figure, item) determines the axis settings. ¥\circled{5}\circlednote{5}{determines the axis setting through the container property \code{SettingsAxis}, which derives from \code{Settings}.}¥
%%%% ¡settings!
'SettingsAxis'
%%%% ¡default!
SettingsAxis('GRID', false, 'AXIS', false) ¥\circled{6}\circlednote{6}{defines the default values by instantiating a default instance of \code{SettingsAxis}.}¥
            %%%%%%% ¡postset!
            %%%if pf.get('DRAWN')
            %%%    toolbar = pf.get('H_TOOLBAR');
            %%%    if check_graphics(toolbar, 'uitoolbar')
            %%%        set(findobj(toolbar, 'Tag', 'TOOL.Grid'), 'State', pf.get('ST_AXIS').get('GRID'))
            %%%        set(findobj(toolbar, 'Tag', 'TOOL.Axis'), 'State', pf.get('ST_AXIS').get('AXIS'))
            %%%    end
            %%%end
%%%% ¡gui! ¥\circled{7}\circlednote{7}{employs the property panel \code{SettingsAxisPP}, which is specialized for \code{SettingsAxis} and derives from \code{SettingsPP}.}¥
pr = SettingsAxisPP('EL', pf, 'PROP', BrainSurfacePF.ST_AXIS, varargin{:});

            %%%%%% ¡prop!
            %%%LISTENER_ST_AXIS (evanescent, handle) contains the listener to the axis settings to update the pushbuttons.
            %%%%%%% ¡calculate!
            %%%value = listener(pf.get('ST_AXIS'), 'PropSet', @cb_listener_st_axis); 
            %%%%%%% ¡calculate_callbacks!
            %%%function cb_listener_st_axis(~, ~)
            %%%    if pf.get('DRAWN')
            %%%        toolbar = pf.get('H_TOOLBAR');
            %%%        if check_graphics(toolbar, 'uitoolbar')
            %%%            set(findobj(toolbar, 'Tag', 'TOOL.Grid'), 'State', pf.get('ST_AXIS').get('GRID'))
            %%%            set(findobj(toolbar, 'Tag', 'TOOL.Axis'), 'State', pf.get('ST_AXIS').get('AXIS'))
            %%%        end
            %%%    end
            %%%end

%%% ¡prop!
SURFFILE (figure, option) is the name of the file of the brain surface to be plotted. ¥\circled{8}\circlednote{8}{contains the file from which the brain surface is plotted.}¥
%%%% ¡settings!
{dir([fileparts(which('braph2')) filesep() 'brainsurfs' filesep() '*.nv']).name}
%%%% ¡default!
'human_ICBM152.nv'
%%%% ¡postset! ¥\circled{9}\circlednote{9}{is executed only when the \code{SURFILE} property is set. It updates the property \code{SURF} loading the data from the file. It the figure panel is already drawn, it refreshes the brain handle and redraws it.}¥
bs = ImporterBrainSurfaceNV('FILE', pf.get('SURFFILE')).get('SURF');
pf.set('SURF', bs)

if pf.get('DRAWN')
    delete(pf.get('H_BRAIN'))
    pf.set('H_BRAIN', Element.getNoValue())

    pf.memorize('H_BRAIN')

    pf.set('BRAIN', pf.get('BRAIN'))

    pf.memorize('ST_SURFACE').set('PANEL', pf, 'PROP', pf.H_BRAIN).get('SETUP')

    pf.memorize('ST_AMBIENT').set('PANEL', pf, 'PROP', pf.H_AXES).get('SETUP')
end

%%% ¡prop!
SURF (metadata, item) is the brain surface to be plotted. ¥\circled{10}\circlednote{10}{contains the \code{BrainSurface} element.}¥
%%%% ¡settings!
'BrainSurface'
%%%% ¡default!
ImporterBrainSurfaceNV('FILE', BrainSurfacePF.getPropDefault('SURFFILE')).get('SURF')

%%% ¡prop!
H_BRAIN (evanescent, handle) is the handle for brain surface. ¥\circled{11}\circlednote{11}{is the evanescent handle for the brain surface. This is calcualted by \circled{12}.}¥
%%%% ¡calculate! ¥\circled{12}¥
triangles = pf.get('SURF').get('TRIANGLES');
coordinates = pf.get('SURF').get('COORDINATES');
h_brain = trisurf( ...
    triangles, ...
    coordinates(:, 1), ...
    coordinates(:, 2), ...
    coordinates(:, 3), ...
    'Parent', pf.memorize('H_AXES'), ...
    'Tag', 'H_BRAIN' ...
    );
xlabel(pf.get('H_AXES'), 'Sagittal')
ylabel(pf.get('H_AXES'), 'Axial')
zlabel(pf.get('H_AXES'), 'Coronal')
value = h_brain;

%%% ¡prop!
BRAIN (figure, logical) determines whether the brain surface is shown. ¥\circled{13}\circlednote{13}{determines whether the brain surface is shown.}¥
%%%% ¡default!
true
%%%% ¡postset!
if pf.get('DRAWN')
    if pf.get('BRAIN')
        set(pf.get('H_BRAIN'), 'Visible', 'on')
    else % ~pf.get('BRAIN') 
        set(pf.get('H_BRAIN'), 'Visible', 'off')
    end
            %%%
            %%%    toolbar = pf.get('H_TOOLBAR');
            %%%    if check_graphics(toolbar, 'uitoolbar')
            %%%        set(findobj(toolbar, 'Tag', 'TOOL.Brain'), 'State', pf.get('BRAIN'))
            %%%    end
end

%%% ¡prop!
ST_SURFACE (figure, item) determines the surface settings. ¥\circled{14}\circlednote{14}{determines the brain surface settings throught the container property \code{SettingsSurface}, which derives from \code{Settings}.}¥
%%%% ¡settings!
'SettingsSurface'
%%%% ¡gui!
pr = SettingsSurfacePP('EL', pf, 'PROP', BrainSurfacePF.ST_SURFACE, varargin{:}); ¥\circled{15}\circlednote{15}{employs the property panel \code{SettingsSurfacePP}, which is specialized for \code{SettingsSurface} and derives from \code{SettingsPP}.}¥

%%% ¡prop!
ST_AMBIENT (figure, item) determines the ambient settings. ¥\circled{16}\circlednote{16}{determines the ambient lighting settings throught the container property \code{SettingsAmbient}, which is derived from \code{Settings}.}¥
%%%% ¡settings!
'SettingsAmbient'
%%%% ¡default!
SettingsAmbient('LIGHTING', 'gouraud', 'MATERIAL', 'dull', 'CAMLIGHT', 'headlight (x2)', 'SHADING', 'none', 'COLORMAP', 'none') ¥\circled{17}\circlednote{17}{defines the default values by instantiating a default instance of \code{SettingsAmbient}.}¥
%%%% ¡gui!
pr = SettingsAmbientPP('EL', pf, 'PROP', BrainSurfacePF.ST_AMBIENT, varargin{:}); ¥\circled{18}\circlednote{18}{employs the property panel \code{SettingsAmbientPP}, which is specialized for \code{SettingsAmbient} and derives from \code{SettingsPP}.}¥
\end{lstlisting}

\begin{lstlisting}[
	label=cd:pf:brainsurfacepf:props_update,
	caption={
		{\bf BrainSurfacePF element props update.}
		The \code{props\_update} section of the generator code for \fn{\_BrainSurfacePF.gen.m} updates the properties of the \code{PanelFig} element. This defines the core properties of the property panel.
	}
]
%% ¡props_update!
...
%%% ¡prop!
DRAW (query, logical) draws the figure brain surface. ¥\circled{1}\circlednote{1}{initializes the various graphical elements are drawn.}¥
%%%% ¡calculate!
value = calculateValue@PanelFig(pf, PanelFig.DRAW, varargin{:}); ¥\circled{2}\circlednote{2}{calls the constructor of the parent. It returns \code{value = true} if the panel is drawn correctly. It gives a warning if the panel is not drawn correctly.}¥
if value
    pf.memorize('H_AXES') ¥\circled{3}\circlednote{3}{ensures that the axes are memorized.}¥
            %%%        
            %%%    pf.set('VIEW', pf.get('VIEW'))

    pf.memorize('ST_AXIS').set('PANEL', pf, 'PROP', BrainSurfacePF.H_AXES).get('SETUP') ¥\circled{4}\circlednote{4}{creates, memorizes, and sets up the property \code{H\_AXES}.}¥
            %%%    pf.memorize('LISTENER_ST_AXIS');
    
    pf.memorize('H_BRAIN') ¥\circled{5}\circlednote{5}{memorizes the property \code{H\_BRAIN}.}¥
            %%%    
            %%%    pf.set('BRAIN', pf.get('BRAIN'))

    pf.memorize('ST_SURFACE').set('PANEL', pf, 'PROP', BrainSurfacePF.H_BRAIN).get('SETUP') ¥\circled{6}\circlednote{6}{creates, memorizes, and sets up the property \code{ST\_SURFACE}.}¥
    
    pf.memorize('ST_AMBIENT').set('PANEL', pf, 'PROP', BrainSurfacePF.H_AXES).get('SETUP') ¥\circled{7}\circlednote{7}{creates, memorizes, and sets up the property \code{ST\_AMBIENT}.}¥
end

%%% ¡prop!
DELETE (query, logical) resets the handles when the panel figure brain surface is deleted. ¥\circled{8}\circlednote{8}{deletes all evanescent hnadles when the figure containing the panel is deleted.}¥
%%%% ¡calculate!
value = calculateValue@PanelFig(pf, PanelFig.DELETE, varargin{:}); % also warning
if value
    pf.set('H_AXES', Element.getNoValue())
    pf.set('H_BRAIN', Element.getNoValue())
            %%%    
            %%%    pf.set('LISTENER_ST_AXIS', Element.getNoValue())
end

            %%%%%% ¡prop!
            %%%H_TOOLS (evanescent, handlelist) is the list of panel-specific tools from the first.
            %%%%%%% ¡calculate!
            %%%toolbar = pf.memorize('H_TOOLBAR');
            %%%if check_graphics(toolbar, 'uitoolbar')
            %%%    value = calculateValue@PanelFig(pf, PanelFig.H_TOOLS);
            %%%    
            %%%    tool_separator_1 = uipushtool(toolbar, 'Separator', 'on', 'Visible', 'off');
            %%%
            %%%    % Brain
            %%%    tool_brain = uitoggletool(toolbar, ...
            %%%        'Tag', 'TOOL.Brain', ...
            %%%        'Separator', 'on', ...
            %%%        'State', pf.get('BRAIN'), ...
            %%%        'Tooltip', 'Show Brain', ...
            %%%        'CData', imread('icon_brain.png'), ...
            %%%        'OnCallback', {@cb_brain, true}, ...
            %%%        'OffCallback', {@cb_brain, false});
            %%%
            %%%    % Axis
            %%%    tool_axis = uitoggletool(toolbar, ...
            %%%        'Tag', 'TOOL.Axis', ...
            %%%        'State', pf.get('ST_AXIS').get('AXIS'), ...
            %%%        'Tooltip', 'Show axis', ...
            %%%        'CData', imread('icon_axis.png'), ...
            %%%        'OnCallback', {@cb_axis, true}, ...
            %%%        'OffCallback', {@cb_axis, false});
            %%%
            %%%    % Grid
            %%%    tool_grid = uitoggletool(toolbar, ...
            %%%        'Tag', 'TOOL.Grid', ...
            %%%        'State', pf.get('ST_AXIS').get('GRID'), ...
            %%%        'Tooltip', 'Show grid', ...
            %%%        'CData', imread('icon_grid.png'), ...
            %%%        'OnCallback', {@cb_grid, true}, ...
            %%%        'OffCallback', {@cb_grid, false});
            %%%        
            %%%    tool_separator_2 = uipushtool(toolbar, 'Separator', 'on', 'Visible', 'off');
            %%%
            %%%    % View 3D
            %%%    tool_view3D = uitoggletool(toolbar, ...
            %%%        'Tag', 'TOOL.View3D', ...
            %%%        'Separator', 'on', ... 
            %%%        'State', isequal(pf.get('VIEW'), BrainSurfacePF.VIEW_3D_AZEL), ...
            %%%        'Tooltip', BrainSurfacePF.VIEW_3D_CMD, ...
            %%%        'CData', imread('icon_view_3d.png'), ...
            %%%        'ClickedCallback', {@cb_view, BrainSurfacePF.VIEW_3D_AZEL});
            %%%
            %%%    % View SL
            %%%    tool_viewSL = uitoggletool(toolbar, ...
            %%%        'Tag', 'TOOL.ViewSL', ...
            %%%        'State', isequal(pf.get('VIEW'), BrainSurfacePF.VIEW_SL_AZEL), ...
            %%%        'Tooltip', BrainSurfacePF.VIEW_SL_CMD, ...
            %%%        'CData', imread('icon_view_sl.png'), ...
            %%%        'ClickedCallback', {@cb_view, BrainSurfacePF.VIEW_SL_AZEL});
            %%%
            %%%    % View SR
            %%%    tool_viewSR = uitoggletool(toolbar, ...
            %%%        'Tag', 'TOOL.ViewSR', ...
            %%%        'State', isequal(pf.get('VIEW'), BrainSurfacePF.VIEW_SR_AZEL), ...
            %%%        'Tooltip', BrainSurfacePF.VIEW_SR_CMD, ...
            %%%        'CData', imread('icon_view_sr.png'), ...
            %%%        'ClickedCallback', {@cb_view, BrainSurfacePF.VIEW_SR_AZEL});
            %%%
            %%%    % View AD
            %%%    tool_viewAD = uitoggletool(toolbar, ...
            %%%        'Tag', 'TOOL.ViewAD', ...
            %%%        'State', isequal(pf.get('VIEW'), BrainSurfacePF.VIEW_AD_AZEL), ...
            %%%        'Tooltip', BrainSurfacePF.VIEW_AD_CMD, ...
            %%%        'CData', imread('icon_view_ad.png'), ...
            %%%        'ClickedCallback', {@cb_view, BrainSurfacePF.VIEW_AD_AZEL});
            %%%
            %%%    % View AV
            %%%    tool_viewAV = uitoggletool(toolbar, ...
            %%%        'Tag', 'TOOL.ViewAV', ...
            %%%        'State', isequal(pf.get('VIEW'), BrainSurfacePF.VIEW_AV_AZEL), ...
            %%%        'Tooltip', BrainSurfacePF.VIEW_AV_CMD, ...
            %%%        'CData', imread('icon_view_av.png'), ...
            %%%        'ClickedCallback', {@cb_view, BrainSurfacePF.VIEW_AV_AZEL});
            %%%
            %%%    % View CA
            %%%    tool_viewCA = uitoggletool(toolbar, ...
            %%%        'Tag', 'TOOL.ViewCA', ...
            %%%        'State', isequal(pf.get('VIEW'), BrainSurfacePF.VIEW_CA_AZEL), ...
            %%%        'Tooltip', BrainSurfacePF.VIEW_CA_CMD, ...
            %%%        'CData', imread('icon_view_ca.png'), ...
            %%%        'ClickedCallback', {@cb_view, BrainSurfacePF.VIEW_CA_AZEL});
            %%%
            %%%    % View CP
            %%%    tool_viewCP = uitoggletool(toolbar, ...
            %%%        'Tag', 'TOOL.ViewCP', ...
            %%%        'State', isequal(pf.get('VIEW'), BrainSurfacePF.VIEW_CP_AZEL), ...
            %%%        'Tooltip', BrainSurfacePF.VIEW_CP_CMD, ...
            %%%        'CData', imread('icon_view_cp.png'), ...
            %%%        'ClickedCallback', {@cb_view, BrainSurfacePF.VIEW_CP_AZEL});
            %%%    
            %%%    value = {value{:}, ...
            %%%        tool_separator_1, ...
            %%%        tool_brain, tool_axis, tool_grid, ...
            %%%        tool_separator_2, ...
            %%%        tool_view3D, tool_viewSL, tool_viewSL, tool_viewSR, tool_viewAD, tool_viewAV, tool_viewCA, tool_viewCP ...
            %%%        };
            %%%else
            %%%    value = {};
            %%%end
            %%%%%%% ¡calculate_callbacks!
            %%%function cb_brain(~, ~, brain) % (src, event)
            %%%    pf.set('BRAIN', brain)
            %%%end
            %%%function cb_axis(~, ~, axis) % (src, event)
            %%%    pf.get('ST_AXIS').set('AXIS', axis);
            %%%    
            %%%    % triggers the update of ST_AXIS
            %%%    pf.set('ST_AXIS', pf.get('ST_AXIS'))
            %%%end
            %%%function cb_grid(~, ~, grid) % (src, event)
            %%%    pf.get('ST_AXIS').set('GRID', grid);
            %%%
            %%%    % triggers the update of ST_AXIS
            %%%    pf.set('ST_AXIS', pf.get('ST_AXIS'))
            %%%end
            %%%function cb_view(~, ~, azel) % (src, event)
            %%%    pf.set('VIEW', azel)
            %%%end
\end{lstlisting}

\begin{lstlisting}[
	label=cd:pf:brainsurfacepf:tests,
	caption={
		{\bf BrainSurfacePF element tests.}
		The \code{tests} section of the generator code for \fn{\_BrainSurfacePF.gen.m} determines how the unit tests are performd.
	}
]
%% ¡tests!

%%% ¡excluded_props! ¥\circled{1}\circlednote{1}{some properties need to be excluded from the tests, mainly because they are initialized by other proprties and therefore could give some spurious errors.}¥
[BrainSurfacePF.PARENT BrainSurfacePF.H BrainSurfacePF.ST_POSITION BrainSurfacePF.ST_AXIS BrainSurfacePF.ST_SURFACE BrainSurfacePF.ST_AMBIENT]
            %%%[BrainSurfacePF.PARENT BrainSurfacePF.H BrainSurfacePF.ST_POSITION BrainSurfacePF.ST_AXIS BrainSurfacePF.ST_SURFACE BrainSurfacePF.ST_AMBIENT BrainSurfacePF.LISTENER_ST_AXIS] 

%%% ¡warning_off!
true

%%% ¡test!
%%%% ¡name!
Remove Figures
%%%% ¡code!
warning('off', [BRAPH2.STR ':BrainSurfacePF'])
assert(length(findall(0, 'type', 'figure')) == 1) ¥\circled{2}\circlednote{2}{throws an error if there remains a different number of figures than expected.}¥
delete(findall(0, 'type', 'figure')) ¥\circled{3}\circlednote{3}{removes the figures remaining from the testing.}¥
warning('on', [BRAPH2.STR ':BrainSurfacePF'])
\end{lstlisting}

\section{Extension of Figure Panel (BrainAtlasPF)}

\subsection{Extension of Toolbar Buttons}

%\bibliography{biblio}
%\bibliographystyle{plainnat}

\end{document}